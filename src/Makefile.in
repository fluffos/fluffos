# YOU DO NOT NEED TO CONFIGURE ANYTHING IN THIS FILE.
#
# RUN THE SHELL SCRIPT ./build.FluffOS to generate the Makefiles, and follow
# its instructions.
#
############################################################################
#
# **** TARGETS AND THEIR CORRECT USAGE ****
#
# COMPILATION TARGETS:
#
# all:		compile all the files
#
# install:	make all, then move the files to the correct directories
#
# test :  automatically run through testsuite standard tests.
#
# 'CLEAN' TARGETS:
#
# clean:	remove everything, also remove .orig and .rej files,
#		cores, lint files, emacs backups, tag files, yacc debug
#		files, generated Makefiles, generated binaries, and
#		generated dependency info
#
# ---- DO NOT EDIT ANYTHING BELOW HERE UNLESS YOU KNOW ALOT ABOUT HOW
#      MUDOS WORKS INTERNALLY ----

# @configure_input@
@SET_MAKE@

CXX=@CXX@
CXXFLAGS=@CXXFLAGS@
LDFLAGS=@CXXFLAGS@ @LDFLAGS@
LIBS=@LIBS@
YACC=@YACC@
O=@OBJEXT@
DRIVER_BIN=@DRIVER_BIN@@EXEEXT@
INSTALL=@INSTALL@
INSTALL_DIR=@bindir@
OPTIMIZE=@OPTIMIZE@

SRC=lpc/compiler/grammar.tab.cc main.cc rc.cc simulate.cc file.cc \
  backend.cc comm.cc ed.cc regexp.cc crc32.cc \
  efuns_main.cc efuns_port.cc \
  call_out.cc otable.cc dumpstat.cc stralloc.cc \
	debugmalloc.cc md.cc \
	hash.cc \
  port.cc reclaim.cc parse.cc simul_efun.cc sprintf.cc \
  avltree.cc \
  socket_efuns.cc socket_ctrl.cc eoperators.cc socket_err.cc \
  disassembler.cc uvalarm.cc \
  replace_program.cc master.cc \
  debug.cc crypt.cc applies_table.cc add_action.cc eval.cc fliconv.cc console.cc \
  posix_timers.cc event.cc dns.c \
	outbuf.cc \
	net/telnet.cc net/telnet_ext.cc net/mssp.cc \
	lpc/interpret.cc lpc/svalue.cc lpc/apply.cc lpc/apply_cache.cc \
	lpc/program.cc lpc/function.cc \
	lpc/lang/array.cc lpc/lang/buffer.cc lpc/lang/class.cc lpc/lang/mapping.cc lpc/lang/object.cc \
	lpc/compiler/compiler.cc lpc/compiler/generate.cc lpc/compiler/icode.cc lpc/comppiler/lex.cc \
	lpc/compiler/scratchpad.cc lpc/compiler/trees.cc \
	thirdparty/libtelnet/libtelnet.c

OBJ=lpc/compiler/grammar.tab.o main.o rc.o simulate.o file.o \
  backend.o comm.o ed.o regexp.o crc32.o \
  efuns_main.o efuns_port.o \
  call_out.o otable.o dumpstat.o stralloc.o \
	debugmalloc.o md.o \
	hash.o \
  port.o reclaim.o parse.o simul_efun.o sprintf.o \
  avltree.o \
  socket_efuns.o socket_ctrl.o eoperators.o socket_err.o \
  disassembler.o uvalarm.o \
  replace_program.o master.o \
  debug.o crypt.o applies_table.o add_action.o eval.o fliconv.o console.o \
  posix_timers.o event.o dns.o \
	outbuf.o \
	net/telnet.o net/telnet_ext.o net/mssp.o \
	lpc/interpret.o lpc/svalue.o lpc/apply.o lpc/apply_cache.o \
	lpc/program.o lpc/function.o \
	lpc/lang/array.o lpc/lang/buffer.o lpc/lang/class.o lpc/lang/mapping.o lpc/lang/object.o \
	lpc/compiler/compiler.o lpc/compiler/generate.o lpc/compiler/icode.o lpc/compiler/lex.o \
	lpc/compiler/scratchpad.o lpc/compiler/trees.o \
	thirdparty/libtelnet/libtelnet.o

VPATH = .:./packages

# ---- BUILD STEPS:
# 1) build edit_source
# 2) use edit_source preprocess stuff.
# 3) main build.

all: local_options files
	$(MAKE) build_packages
	$(MAKE) build_binaries

build_packages:
	$(MAKE) -C packages 'CC=$(CXX)' 'CXXFLAGS=$(CXXFLAGS)' 'A=$(A)' 'O=$(O)'

build_binaries: $(DRIVER_BIN) portbind

.cc.$(O):
	$(CXX) -c $(CXXFLAGS) @zlib_CFLAGS@ @LIBEVENT_CPPFLAGS@ -I. -x c++ -o $@ $<

.c.$(O):
	$(CXX) -c $(CXXFLAGS) @zlib_CFLAGS@ @LIBEVENT_CPPFLAGS@ -I. -x c++ -o $@ $<

# Hack to work around brokeness in libtelnet.c
thirdparty/libtelnet/libtelnet.o: thirdparty/libtelnet/libtelnet.c
	if [ -n "@zlib_LIBS@" ]; then \
		$(CXX) -c $(CXXFLAGS) -DHAVE_ZLIB @zlib_CFLAGS@ @LIBEVENT_CPPFLAGS@ -I. -x c++ -o $@ $< ; \
	else \
		$(CXX) -c $(CXXFLAGS) @zlib_CFLAGS@ @LIBEVENT_CPPFLAGS@ -I. -x c++ -o $@ $< ; \
	fi

# FIXME: simulate.c currently calls package_async, which depends on package/DB, this need to be fixed.
simulate.$(O): simulate.cc
	$(CXX) -c $(CXXFLAGS) -I. @LIBEVENT_CPPFLAGS@ @MYSQL_CFLAGS@ @POSTGRESQL_CFLAGS@ @SQLITE3_CFLAGS@  -x c++ -o $@ $<

lpc/compiler/grammar.tab.o: lpc/compiler/grammar.tab.cc opcodes.h

lpc/compiler/grammar.tab.cc: lpc/compiler/grammar.y
	-rm -f lpc/compiler/grammar.tab.*
	$(YACC) -d lpc/compiler/grammar.y
	mv y.tab.c lpc/compiler/grammar.tab.cc
	mv y.tab.h lpc/compiler/grammar.tab.h

$(DRIVER_BIN): $(OBJ) packages/*.$(O) dtrace_compile
	-mv -f $(DRIVER_BIN) $(DRIVER_BIN).old
	$(CXX) $(LDFLAGS) $(OBJ) packages/*.$(O) `./dtrace_compile` -o $(DRIVER_BIN) $(LIBS) @MYSQL_LDFLAGS@ @POSTGRESQL_LDFLAGS@ @SQLITE3_LDFLAGS@ @OPENSSL_LDFLAGS@ @OPENSSL_LIBS@ @PCRE_LIBS@ @LIBEVENT_LIBS@ @LIBEVENT_LDFLAGS@ @zlib_LIBS@

dtrace_compile: dtrace_compile.cc
	$(CXX) $(CXXFLAGS) -x c++ dtrace_compile.cc -o dtrace_compile

portbind: portbind.o
	$(CXX) $(LDFLAGS) portbind.o -o portbind $(LIBS)

cc.h:
	rm -f cc.h
	echo "/* this file automatically generated by the Makefile */" > cc.h
	echo '#define COMPILER "$(CXX)"' >> cc.h
	echo '#define CXXFLAGS "$(CXXFLAGS)"' >> cc.h
	echo '#define OPTIMIZE "$(OPTIMIZE)"' >> cc.h
	echo '#define SOURCE_REVISION "@SOURCE_REVISION@"' >> cc.h

# the touches here are necessary to fix the modification times; link(2) does
# 'modify' a file
files: edit_source options.h lpc/op.spec lpc/func.spec configure.h lpc/compiler/grammar.y.pre
	./edit_source -options -build_func_spec '$(CXX) -E $(CXXFLAGS) -I. -x c++' \
	              -process lpc/compiler/grammar.y.pre
	./edit_source -build_efuns -build_applies
	touch files

make_func.tab.cc: make_func.y cc.h
	-rm -f make_func.tab.*
	$(YACC) -d make_func.y
	mv y.tab.h make_func.tab.h
	mv y.tab.c make_func.tab.cc

edit_source: edit_source.o hash.o make_func.tab.o
	$(CXX) $(CXXFLAGS) edit_source.o hash.o make_func.tab.o -o edit_source

# don't optimize these two
edit_source.o: edit_source.cc lpc/compiler/preprocess.cc cc.h
	$(CXX) $(CXXFLAGS) -o $@ -c -x c++ $<

make_func.tab.o: make_func.tab.cc
	$(CXX) $(CXXFLAGS) -o $@ -c -x c++ $<

install: all
	-mkdir $(INSTALL_DIR)
	$(INSTALL) $(DRIVER_BIN) $(INSTALL_DIR)
	$(INSTALL) portbind $(INSTALL_DIR)

# remove everything
clean:
	-$(MAKE) -C packages "A=$(A)" "O=$(O)" clean
	-find . -name "*.$(O)" | xargs rm -rf
	-find . -name "*.gcda" | xargs rm -rf
	-find . -name "*.gcno" | xargs rm -rf
	-find . -name "*.gcov" | xargs rm -rf
	-rm -rf *.d *.tab.cc *.tab.h
	-rm -f efun_defs.cc option_defs.cc
	-rm -f opcodes.h efunctions.h opc.h efun_protos.h
	-rm -f lpc/*.generated applies.h applies_table.cc files
	-rm -f lpc/compiler/grammar.y lpc/compiler/grammar.tab.*
	-rm -f comptest* a.out *.exe
	-rm -f packages/packages
	-rm -f Makefile.MudOS GNUmakefile.MudOS
	-rm -f cc.h edit_source
	-rm -f core y.output testsuite/core testsuite/tmp/*
	-rm -f testsuite/OPCPROF.* testsuite/opc.*
	-rm -rf testsuite/binaries testsuite/single/swapfile.*
	-rm -f testsuite/OBJ_DUMP* testsuite/test_file testsuite/testfile
	-rm -f testsuite/tmp_eval_file.c testsuite/sf.o testsuite/ed_test
	-rm -f testsuite/log/log testsuite/log/debug.log testsuite/log/compile
	-find . -name "*~" -print | xargs rm
	-find . -name "*.orig" -print | xargs rm
	-find . -name "*.rej" -print | xargs rm
	-rm -f *.ln tags TAGS
	-rm -f $(DRIVER_BIN) $(DRIVER_BIN).old portbind *.exe
	-rm -f 1.out 2.out
	-rm -f dtrace_compile
	-rm -f testsuite/log/author_stats testsuite/log/domain_stats
	-rm -f testsuite/tmp.o                                  

reconfigure: clean
	rm -f conf.h configure.h options_incl.h

test: all
	cd testsuite && ../driver -d -ftest etc/config.test

help:
	@echo "***************** Configuration completed **************"
	@echo "Compiling @PACKAGE_STRING@ (@SOURCE_REVISION@) as $(DRIVER_BIN) for @target@."
	@echo
	@echo "INSTALL: '$(INSTALL)'"
	@echo "INSTALL DIR: '$(INSTALL_DIR)'"
	@echo "BISON/YACC: '$(YACC)'"
	@echo "PREPROCESSING: '$(CXX) -E $(CPPFLAGS) $(CXXFLAGS)'"
	@echo "COMPILE: '$(CXX) $(CFALGS) $(CXXFLAGS)'"
	@echo "LINK: '$(CXX) $(LDFLAGS)'"
	@echo
	@if [ -n "@LIBEVENT_LIBS@" ]; then echo "LIBEVENT: '@LIBEVENT_LIBS@', '@LIBEVENT_CPPFLAGS@', '@LIBEVENT_LDFLAGS@'"; fi
	@if [ -n "@MYSQL_VERSION@" ]; then echo "MYSQL: '@MYSQL_VERSION@', '@MYSQL_CFLAGS@', '@MYSQL_LDFLAGS@'"; fi
	@if [ -n "@POSTGRESQL_VERSION@" ];then echo "POSTGRESQL: '@POSTGRESQL_VERSION@', '@POSTGRESQL_CFLAGS@', '@POSTGRESQL_LDFLAGS@'"; fi
	@if [ -n "@SQLITE3_VERSION@" ]; then echo "SQLite3: '@SQLITE3_VERSION@', '@SQLITE3_CFLAGS@', '@SQLITE3_LDFLAGS@'"; fi
	@if [ -n "@OPENSSL_LIBS@" ]; then echo "OPENSSL: '@OPENSSL_LIBS@', '@OPENSSL_INCLUDES@', '@OPENSSL_LDFLAGS@'"; fi
	@if [ -n "@PCRE_LIBS@" ]; then echo "PCRE: '@PCRE_LIBS@', '@PCRE_CFLAGS@'"; fi
	@echo
	@echo "Compiler Version:"
	-@$(CXX) -v
	@echo "Edit Makefile if this is not what you want"
	@echo
	@echo "Otherwise, type '$(MAKE)' to build FluffOS, then '$(MAKE) install'."
